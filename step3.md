いよいよ、このアプリの核となる「Zigzagging」によるノード定義機能を実装します。これはユーザーとLLMの対話によって実現します。

**前提:**
*   ステップ2のコードに追記・修正します。
*   UIはチャット形式で実装します。

**要件:**
1.  **セッションステートの追加:**
    *   チャットの対話履歴を保存するため、セッションステートの初期化時に `messages` というキーを持つリストを追加してください。(例: `st.session_state.messages = []`)
2.  **UIの追加:**
    *   メイン画面に「3. ノードの定義 (Zigzagging)」という見出しを追加してください。
    *   これまでのチャット履歴を表示するエリアを設けてください。`st.chat_message` を使用します。
    *   ユーザーがメッセージを入力するためのチャット入力欄 (`st.chat_input`) を設置してください。
3.  **対話開始のトリガー:**
    *   `project_data['functional_categories']` が空でない場合、チャットの最初のメッセージとして、アシスタント（LLM）からの開始メッセージを自動で表示してください。
        *   例: 「こんにちは！生産技術コンサルタントです。定義された機能カテゴリに基づき、プロセスの具体的なノード（作業工程、道具、材料など）を洗い出していきましょう。まずは『[最初のカテゴリ名]』について、どのような具体的な要素がありますか？」
4.  **チャットロジックの実装:**
    *   ユーザーがチャット入力欄からメッセージを送信したら、以下の処理を実行します。
    *   ユーザーのメッセージを履歴に追加し、画面に表示します。
    *   アシスタントの応答を生成するため、OpenAI APIにリクエストを送信します。このとき、過去の対話履歴 (`st.session_state.messages`) と、システムプロンプトを渡してください。
        *   **システムプロンプト (重要):**
            ```
            あなたは生産技術コンサルタントであり、ユーザーとの対話を通じて生産プロセスの「ノード」を定義する専門家です。あなたの役割は「Zigzagging」と呼ばれるプロセスを主導することです。
            1. **機能から実体へ:** ユーザーに質問し、機能カテゴリを実現するための具体的な実体（作業工程、道具、材料、スキルなど）を洗い出させます。
            2. **実体から機能へ:** ユーザーが挙げた実体について、さらに深掘りする質問をします。「その作業はさらにどのような細かい工程に分けられますか？」「その道具を使う目的は何ですか？」のように問いかけ、実体を下位の機能やノードに分解させます。
            3. **ノードの提案:** ユーザーの回答が曖昧な場合、具体的なノードの候補を提案してください。
            4. **構造化:** 対話の最後に、洗い出されたノードをリスト形式で要約して提示し、ユーザーに確認を求めてください。出力するノード名は、簡潔で一意な名詞句にしてください。
            常に対話の主導権を握り、プロセス全体の解像度が上がるようにユーザーを導いてください。
            ```
    *   APIからの応答を履歴に追加し、画面に表示します。
5.  **ノードの確定と保存:**
    *   UIに「対話からノードを抽出して保存」ボタンを設置してください。
    *   このボタンが押されたら、LLMに再度リクエストを投げます。
        *   **タスク:** これまでの全対話履歴を渡し、「この対話から抽出される全てのノ-ドを、重複なくPythonのリスト形式（例: `["材料を混ぜる", "オーブンで焼く"]`）で出力してください。他の説明は不要です。」と指示します。
    *   得られたノードのリストを `project_data['nodes']` に保存します。
    *   保存されたノードは `st.data_editor` を使って一覧表示し、最終的な編集ができるようにしてください。

**コード品質への要求:**
*   チャットの履歴管理とAPI呼び出しのロジックを明確に分離してください。
*   システムプロンプトは非常に重要なので、一言一句正確に実装してください。

この複雑な要件を満たすための更新コードを生成してください。